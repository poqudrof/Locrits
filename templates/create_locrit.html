{% extends "base.html" %}

{% block title %}CrÃ©er un Locrit - Locrit{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>â• CrÃ©er un nouveau Locrit</h1>
    <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
        â† Retour Ã  la liste
    </a>
</div>

<form method="POST" class="container-sm">
    <!-- Informations gÃ©nÃ©rales -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">ğŸ“ Informations gÃ©nÃ©rales</h3>
        </div>

        <div class="form-group">
            <label for="name" class="form-label">Nom du Locrit *</label>
            <input type="text"
                   id="name"
                   name="name"
                   class="form-control"
                   placeholder="Ex: Assistant Personnel, Bob Technique..."
                   required
                   value="{{ request.form.name if request.form.name }}">
            <small class="text-muted">Le nom doit Ãªtre unique et servira d'identifiant.</small>
        </div>

        <div class="form-group">
            <label for="description" class="form-label">Description *</label>
            <textarea id="description"
                      name="description"
                      class="form-control form-textarea"
                      placeholder="DÃ©crivez le rÃ´le et les capacitÃ©s de ce Locrit..."
                      required>{{ request.form.description if request.form.description }}</textarea>
            <small class="text-muted">Une description claire aide Ã  comprendre le rÃ´le du Locrit.</small>
        </div>

        <div class="form-group">
            <label for="model" class="form-label">ModÃ¨le Ollama *</label>
            <input type="text"
                   id="model"
                   name="model"
                   class="form-control"
                   placeholder="llama3.2"
                   required
                   value="{{ request.form.model if request.form.model else 'llama3.2' }}">
            <small class="text-muted">Le modÃ¨le Ollama Ã  utiliser (ex: llama3.2, codellama, mistral...).</small>
        </div>

        <div class="form-group">
            <label for="public_address" class="form-label">Adresse publique</label>
            <input type="text"
                   id="public_address"
                   name="public_address"
                   class="form-control"
                   placeholder="mon-locrit.localhost.run"
                   value="{{ request.form.public_address if request.form.public_address }}">
            <small class="text-muted">Optionnel. Adresse pour accÃ©der au Locrit depuis l'extÃ©rieur.</small>
        </div>
    </div>

    <!-- ParamÃ¨tres d'accÃ¨s -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">ğŸ” Ouvert Ã </h3>
            <p class="card-subtitle">Qui peut se connecter Ã  ce Locrit ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="humans" name="humans" checked>
            <label for="humans" class="form-label">ğŸ‘¥ Humains</label>
            <small class="text-muted d-block">Permettre aux utilisateurs humains de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="locrits" name="locrits" checked>
            <label for="locrits" class="form-label">ğŸ¤– Autres Locrits</label>
            <small class="text-muted d-block">Permettre aux autres Locrits de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="invitations" name="invitations" checked>
            <label for="invitations" class="form-label">ğŸ“§ Invitations</label>
            <small class="text-muted d-block">Accepter les invitations externes</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="internet" name="internet">
            <label for="internet" class="form-label">ğŸŒ Internet</label>
            <small class="text-muted d-block">AccÃ¨s autonome Ã  Internet (expÃ©rimental)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="platform" name="platform">
            <label for="platform" class="form-label">ğŸ¢ Plateforme</label>
            <small class="text-muted d-block">Interactions avec la plateforme Locrit</small>
        </div>
    </div>

    <!-- AccÃ¨s aux donnÃ©es -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">ğŸ“Š AccÃ¨s aux donnÃ©es</h3>
            <p class="card-subtitle">Quelles donnÃ©es ce Locrit peut-il consulter ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="logs" name="logs" checked>
            <label for="logs" class="form-label">ğŸ“ Logs systÃ¨me</label>
            <small class="text-muted d-block">AccÃ¨s aux journaux d'activitÃ© du systÃ¨me</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="quick_memory" name="quick_memory" checked>
            <label for="quick_memory" class="form-label">ğŸ§  MÃ©moire rapide</label>
            <small class="text-muted d-block">AccÃ¨s Ã  la mÃ©moire de conversation rÃ©cente</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="full_memory" name="full_memory">
            <label for="full_memory" class="form-label">ğŸ—„ï¸ MÃ©moire complÃ¨te</label>
            <small class="text-muted d-block">AccÃ¨s Ã  toute la mÃ©moire historique (sensible)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="llm_info" name="llm_info" checked>
            <label for="llm_info" class="form-label">ğŸ¤– Informations LLM</label>
            <small class="text-muted d-block">AccÃ¨s aux mÃ©tadonnÃ©es du modÃ¨le de langage</small>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
            Annuler
        </a>
        <button type="submit" class="btn btn-success">
            âœ… CrÃ©er le Locrit
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Validation du formulaire
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const model = document.getElementById('model').value.trim();

    if (!name) {
        e.preventDefault();
        alert('Le nom du Locrit est obligatoire.');
        document.getElementById('name').focus();
        return;
    }

    if (!description) {
        e.preventDefault();
        alert('La description est obligatoire.');
        document.getElementById('description').focus();
        return;
    }

    if (!model) {
        e.preventDefault();
        alert('Le modÃ¨le Ollama est obligatoire.');
        document.getElementById('model').focus();
        return;
    }

    // Validation du nom (pas de caractÃ¨res spÃ©ciaux problÃ©matiques)
    if (!/^[a-zA-Z0-9\s\-_]+$/.test(name)) {
        e.preventDefault();
        alert('Le nom du Locrit ne peut contenir que des lettres, chiffres, espaces, tirets et underscores.');
        document.getElementById('name').focus();
        return;
    }

    // DÃ©sactiver le bouton de soumission
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'â³ CrÃ©ation en cours...';
});

// Auto-focus sur le champ nom
document.getElementById('name').focus();

// Suggestions de modÃ¨les Ollama
const modelInput = document.getElementById('model');
const commonModels = ['llama3.2', 'llama3.1', 'codellama', 'mistral', 'phi3', 'gemma2'];

modelInput.addEventListener('input', function() {
    // Simple suggestion (peut Ãªtre amÃ©liorÃ© avec une vraie auto-completion)
    const value = this.value.toLowerCase();
    if (value && !commonModels.includes(value)) {
        const suggestions = commonModels.filter(model => model.includes(value));
        if (suggestions.length > 0) {
            console.log('Suggestions:', suggestions);
            // Ici on pourrait afficher les suggestions dans un dropdown
        }
    }
});
</script>
{% endblock %}