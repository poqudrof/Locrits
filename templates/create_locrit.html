{% extends "base.html" %}

{% block title %}Créer un Locrit - Locrit{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>➕ Créer un nouveau Locrit</h1>
    <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
        ← Retour à la liste
    </a>
</div>

<form method="POST" class="container-sm">
    <!-- Informations générales -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">📝 Informations générales</h3>
        </div>

        <div class="form-group">
            <label for="name" class="form-label">Nom du Locrit *</label>
            <input type="text"
                   id="name"
                   name="name"
                   class="form-control"
                   placeholder="Ex: Assistant Personnel, Bob Technique..."
                   required
                   value="{{ request.form.name if request.form.name }}">
            <small class="text-muted">Le nom doit être unique et servira d'identifiant.</small>
        </div>

        <div class="form-group">
            <label for="description" class="form-label">Description *</label>
            <textarea id="description"
                      name="description"
                      class="form-control form-textarea"
                      placeholder="Décrivez le rôle et les capacités de ce Locrit..."
                      required>{{ request.form.description if request.form.description }}</textarea>
            <small class="text-muted">Une description claire aide à comprendre le rôle du Locrit.</small>
        </div>

        <div class="form-group">
            <label for="model" class="form-label">Modèle Ollama *</label>
            <input type="text"
                   id="model"
                   name="model"
                   class="form-control"
                   placeholder="llama3.2"
                   required
                   value="{{ request.form.model if request.form.model else 'llama3.2' }}">
            <small class="text-muted">Le modèle Ollama à utiliser (ex: llama3.2, codellama, mistral...).</small>
        </div>

        <div class="form-group">
            <label for="public_address" class="form-label">Adresse publique</label>
            <input type="text"
                   id="public_address"
                   name="public_address"
                   class="form-control"
                   placeholder="mon-locrit.localhost.run"
                   value="{{ request.form.public_address if request.form.public_address }}">
            <small class="text-muted">Optionnel. Adresse pour accéder au Locrit depuis l'extérieur.</small>
        </div>
    </div>

    <!-- Paramètres d'accès -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">🔐 Ouvert à</h3>
            <p class="card-subtitle">Qui peut se connecter à ce Locrit ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="humans" name="humans" checked>
            <label for="humans" class="form-label">👥 Humains</label>
            <small class="text-muted d-block">Permettre aux utilisateurs humains de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="locrits" name="locrits" checked>
            <label for="locrits" class="form-label">🤖 Autres Locrits</label>
            <small class="text-muted d-block">Permettre aux autres Locrits de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="invitations" name="invitations" checked>
            <label for="invitations" class="form-label">📧 Invitations</label>
            <small class="text-muted d-block">Accepter les invitations externes</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="internet" name="internet">
            <label for="internet" class="form-label">🌐 Internet</label>
            <small class="text-muted d-block">Accès autonome à Internet (expérimental)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="platform" name="platform">
            <label for="platform" class="form-label">🏢 Plateforme</label>
            <small class="text-muted d-block">Interactions avec la plateforme Locrit</small>
        </div>
    </div>

    <!-- Accès aux données -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">📊 Accès aux données</h3>
            <p class="card-subtitle">Quelles données ce Locrit peut-il consulter ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="logs" name="logs" checked>
            <label for="logs" class="form-label">📝 Logs système</label>
            <small class="text-muted d-block">Accès aux journaux d'activité du système</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="quick_memory" name="quick_memory" checked>
            <label for="quick_memory" class="form-label">🧠 Mémoire rapide</label>
            <small class="text-muted d-block">Accès à la mémoire de conversation récente</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="full_memory" name="full_memory">
            <label for="full_memory" class="form-label">🗄️ Mémoire complète</label>
            <small class="text-muted d-block">Accès à toute la mémoire historique (sensible)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="llm_info" name="llm_info" checked>
            <label for="llm_info" class="form-label">🤖 Informations LLM</label>
            <small class="text-muted d-block">Accès aux métadonnées du modèle de langage</small>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
            Annuler
        </a>
        <button type="submit" class="btn btn-success">
            ✅ Créer le Locrit
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Validation du formulaire
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const model = document.getElementById('model').value.trim();

    if (!name) {
        e.preventDefault();
        alert('Le nom du Locrit est obligatoire.');
        document.getElementById('name').focus();
        return;
    }

    if (!description) {
        e.preventDefault();
        alert('La description est obligatoire.');
        document.getElementById('description').focus();
        return;
    }

    if (!model) {
        e.preventDefault();
        alert('Le modèle Ollama est obligatoire.');
        document.getElementById('model').focus();
        return;
    }

    // Validation du nom (pas de caractères spéciaux problématiques)
    if (!/^[a-zA-Z0-9\s\-_]+$/.test(name)) {
        e.preventDefault();
        alert('Le nom du Locrit ne peut contenir que des lettres, chiffres, espaces, tirets et underscores.');
        document.getElementById('name').focus();
        return;
    }

    // Désactiver le bouton de soumission
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '⏳ Création en cours...';
});

// Auto-focus sur le champ nom
document.getElementById('name').focus();

// Suggestions de modèles Ollama
const modelInput = document.getElementById('model');
const commonModels = ['llama3.2', 'llama3.1', 'codellama', 'mistral', 'phi3', 'gemma2'];

modelInput.addEventListener('input', function() {
    // Simple suggestion (peut être amélioré avec une vraie auto-completion)
    const value = this.value.toLowerCase();
    if (value && !commonModels.includes(value)) {
        const suggestions = commonModels.filter(model => model.includes(value));
        if (suggestions.length > 0) {
            console.log('Suggestions:', suggestions);
            // Ici on pourrait afficher les suggestions dans un dropdown
        }
    }
});
</script>
{% endblock %}