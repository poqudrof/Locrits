{% extends "base.html" %}

{% block title %}√âditer {{ locrit_name }} - Locrit{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>‚öôÔ∏è √âditer {{ locrit_name }}</h1>
    <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
        ‚Üê Retour √† la liste
    </a>
</div>

<form method="POST" class="container-sm">
    <!-- Informations g√©n√©rales -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title">üìù Informations g√©n√©rales</h3>
                <div>
                    {% if settings.active %}
                        <span class="badge badge-success">üü¢ Actif</span>
                    {% else %}
                        <span class="badge badge-danger">üî¥ Inactif</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="description" class="form-label">Description *</label>
            <textarea id="description"
                      name="description"
                      class="form-control form-textarea"
                      placeholder="D√©crivez le r√¥le et les capacit√©s de ce Locrit..."
                      required>{{ settings.description }}</textarea>
            <small class="text-muted">Une description claire aide √† comprendre le r√¥le du Locrit.</small>
        </div>

        <div class="form-group">
            <label for="model" class="form-label">Mod√®le Ollama *</label>
            <div class="d-flex gap-2 align-items-end">
                <div style="flex: 1;">
                    <select id="model_select" class="form-control mb-2" style="display: none;">
                        <option value="">‚è≥ Chargement des mod√®les...</option>
                    </select>
                    <input type="text"
                           id="model"
                           name="model"
                           class="form-control"
                           placeholder="llama3.2"
                           required
                           value="{{ settings.ollama_model }}">
                    <small class="text-muted">S√©lectionnez un mod√®le depuis la liste ou saisissez manuellement.</small>
                </div>
                <button type="button" id="refreshModels" class="btn btn-outline" style="height: fit-content;">
                    üîÑ
                </button>
            </div>
            <div id="model_status" class="mt-2" style="display: none;">
                <small class="text-muted">‚è≥ Chargement des mod√®les disponibles...</small>
            </div>
        </div>

        <div class="form-group">
            <label for="public_address" class="form-label">Adresse publique</label>
            <input type="text"
                   id="public_address"
                   name="public_address"
                   class="form-control"
                   placeholder="mon-locrit.localhost.run"
                   value="{{ settings.public_address or '' }}">
            <small class="text-muted">Optionnel. Adresse pour acc√©der au Locrit depuis l'ext√©rieur.</small>
        </div>
    </div>

    <!-- Param√®tres d'acc√®s -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">üîê Ouvert √†</h3>
            <p class="card-subtitle">Qui peut se connecter √† ce Locrit ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="humans" name="humans" {% if settings.open_to.humans %}checked{% endif %}>
            <label for="humans" class="form-label">üë• Humains</label>
            <small class="text-muted d-block">Permettre aux utilisateurs humains de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="locrits" name="locrits" {% if settings.open_to.locrits %}checked{% endif %}>
            <label for="locrits" class="form-label">ü§ñ Autres Locrits</label>
            <small class="text-muted d-block">Permettre aux autres Locrits de se connecter</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="invitations" name="invitations" {% if settings.open_to.invitations %}checked{% endif %}>
            <label for="invitations" class="form-label">üìß Invitations</label>
            <small class="text-muted d-block">Accepter les invitations externes</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="internet" name="internet" {% if settings.open_to.internet %}checked{% endif %}>
            <label for="internet" class="form-label">üåê Internet</label>
            <small class="text-muted d-block">Acc√®s autonome √† Internet (exp√©rimental)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="platform" name="platform" {% if settings.open_to.platform %}checked{% endif %}>
            <label for="platform" class="form-label">üè¢ Plateforme</label>
            <small class="text-muted d-block">Interactions avec la plateforme Locrit</small>
        </div>
    </div>

    <!-- Acc√®s aux donn√©es -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">üìä Acc√®s aux donn√©es</h3>
            <p class="card-subtitle">Quelles donn√©es ce Locrit peut-il consulter ?</p>
        </div>

        <div class="form-check">
            <input type="checkbox" id="logs" name="logs" {% if settings.access_to.logs %}checked{% endif %}>
            <label for="logs" class="form-label">üìù Logs syst√®me</label>
            <small class="text-muted d-block">Acc√®s aux journaux d'activit√© du syst√®me</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="quick_memory" name="quick_memory" {% if settings.access_to.quick_memory %}checked{% endif %}>
            <label for="quick_memory" class="form-label">üß† M√©moire rapide</label>
            <small class="text-muted d-block">Acc√®s √† la m√©moire de conversation r√©cente</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="full_memory" name="full_memory" {% if settings.access_to.full_memory %}checked{% endif %}>
            <label for="full_memory" class="form-label">üóÑÔ∏è M√©moire compl√®te</label>
            <small class="text-muted d-block">Acc√®s √† toute la m√©moire historique (sensible)</small>
        </div>

        <div class="form-check">
            <input type="checkbox" id="llm_info" name="llm_info" {% if settings.access_to.llm_info %}checked{% endif %}>
            <label for="llm_info" class="form-label">ü§ñ Informations LLM</label>
            <small class="text-muted d-block">Acc√®s aux m√©tadonn√©es du mod√®le de langage</small>
        </div>
    </div>

    <!-- Informations de m√©tadonn√©es -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">üìÖ M√©tadonn√©es</h3>
        </div>
        <div class="d-flex gap-4">
            <div>
                <strong>Cr√©√©:</strong><br>
                <span class="text-muted">{{ settings.created_at[:19] if settings.created_at else 'N/A' }}</span>
            </div>
            <div>
                <strong>Derni√®re modification:</strong><br>
                <span class="text-muted">{{ settings.updated_at[:19] if settings.updated_at else 'N/A' }}</span>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 justify-content-between">
        <div>
            <button type="button" id="resetForm" class="btn btn-warning">
                üîÑ Restaurer
            </button>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('locrits_list') }}" class="btn btn-outline">
                Annuler
            </a>
            <button type="submit" class="btn btn-success">
                üíæ Sauvegarder
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Valeurs originales pour la restauration
const originalValues = {
    description: {{ settings.description | tojson }},
    model: {{ settings.ollama_model | tojson }},
    public_address: {{ settings.public_address | tojson or '""' }},
    open_to: {{ settings.open_to | tojson }},
    access_to: {{ settings.access_to | tojson }}
};

// Validation du formulaire
document.querySelector('form').addEventListener('submit', function(e) {
    const description = document.getElementById('description').value.trim();
    const model = document.getElementById('model').value.trim();

    if (!description) {
        e.preventDefault();
        alert('La description est obligatoire.');
        document.getElementById('description').focus();
        return;
    }

    if (!model) {
        e.preventDefault();
        alert('Le mod√®le Ollama est obligatoire.');
        document.getElementById('model').focus();
        return;
    }

    // D√©sactiver le bouton de soumission
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Sauvegarde en cours...';
});

// Restaurer les valeurs originales
document.getElementById('resetForm').addEventListener('click', function() {
    if (confirm('√ätes-vous s√ªr de vouloir restaurer les valeurs originales ? Les modifications non sauvegard√©es seront perdues.')) {
        // Restaurer les champs texte
        document.getElementById('description').value = originalValues.description;
        document.getElementById('model').value = originalValues.model;
        document.getElementById('public_address').value = originalValues.public_address || '';

        // Restaurer les checkboxes open_to
        document.getElementById('humans').checked = originalValues.open_to.humans;
        document.getElementById('locrits').checked = originalValues.open_to.locrits;
        document.getElementById('invitations').checked = originalValues.open_to.invitations;
        document.getElementById('internet').checked = originalValues.open_to.internet;
        document.getElementById('platform').checked = originalValues.open_to.platform;

        // Restaurer les checkboxes access_to
        document.getElementById('logs').checked = originalValues.access_to.logs;
        document.getElementById('quick_memory').checked = originalValues.access_to.quick_memory;
        document.getElementById('full_memory').checked = originalValues.access_to.full_memory;
        document.getElementById('llm_info').checked = originalValues.access_to.llm_info;

        alert('Formulaire restaur√© aux valeurs originales.');
    }
});

// Auto-focus sur le champ description
document.getElementById('description').focus();

// Gestion des mod√®les Ollama
const modelInput = document.getElementById('model');
const modelSelect = document.getElementById('model_select');
const modelStatus = document.getElementById('model_status');
const refreshButton = document.getElementById('refreshModels');

// Fonction pour charger les mod√®les disponibles
async function loadOllamaModels() {
    try {
        modelStatus.style.display = 'block';
        modelStatus.innerHTML = '<small class="text-muted">‚è≥ Chargement des mod√®les disponibles...</small>';

        const response = await fetch('/api/ollama/models');
        const result = await response.json();

        if (result.success && result.models.length > 0) {
            // Vider la liste existante
            modelSelect.innerHTML = '<option value="">-- S√©lectionnez un mod√®le --</option>';

            // Ajouter les mod√®les disponibles
            result.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                if (model.name === modelInput.value) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });

            // Afficher la liste d√©roulante
            modelSelect.style.display = 'block';
            modelStatus.innerHTML = `<small class="text-success">‚úÖ ${result.models.length} mod√®les charg√©s</small>`;

        } else {
            modelStatus.innerHTML = '<small class="text-warning">‚ö†Ô∏è Aucun mod√®le trouv√©. V√©rifiez la connexion Ollama.</small>';
        }

    } catch (error) {
        console.error('Erreur lors du chargement des mod√®les:', error);
        modelStatus.innerHTML = '<small class="text-danger">‚ùå Erreur lors du chargement. Saisie manuelle disponible.</small>';
    }
}

// Gestion de la s√©lection d'un mod√®le
modelSelect.addEventListener('change', function() {
    if (this.value) {
        modelInput.value = this.value;
    }
});

// Bouton de rafra√Æchissement
refreshButton.addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '‚è≥';
    loadOllamaModels().finally(() => {
        this.disabled = false;
        this.innerHTML = 'üîÑ';
    });
});

// Charger les mod√®les au chargement de la page
window.addEventListener('load', function() {
    // Petit d√©lai pour que la page soit compl√®tement charg√©e
    setTimeout(loadOllamaModels, 500);
});

// Avertissement pour les modifications sensibles
document.getElementById('full_memory').addEventListener('change', function() {
    if (this.checked) {
        alert('‚ö†Ô∏è Attention: L\'acc√®s √† la m√©moire compl√®te donne acc√®s √† tout l\'historique. Utilisez avec pr√©caution.');
    }
});

document.getElementById('internet').addEventListener('change', function() {
    if (this.checked) {
        alert('‚ö†Ô∏è Attention: L\'acc√®s autonome √† Internet est exp√©rimental et peut pr√©senter des risques de s√©curit√©.');
    }
});
</script>
{% endblock %}